AWSTemplateFormatVersion: '2010-09-09'
Description: 'RLVR Experiments - Multi-node GPU cluster with EFS and EFA'

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair for SSH access

  InstanceType:
    Type: String
    Default: p4de.24xlarge
    AllowedValues:
      - p4de.24xlarge
      - p4d.24xlarge
      - p5.48xlarge
    Description: GPU instance type (must support EFA)

  InstanceCount:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 8
    Description: Number of GPU instances to launch

  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/deeplearning/ami/x86_64/oss-nvidia-driver-gpu-pytorch-2.5-ubuntu-22.04/latest/ami-id
    Description: AWS Deep Learning AMI with PyTorch (includes NVIDIA drivers, CUDA, EFA)

  ExistingVpcId:
    Type: String
    Default: ''
    Description: (Optional) Existing VPC ID. Leave empty to create a new VPC.

  ExistingSubnetId:
    Type: String
    Default: ''
    Description: (Optional) Existing Subnet ID. Required if ExistingVpcId is provided.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Instance Configuration"
        Parameters:
          - KeyName
          - InstanceType
          - InstanceCount
          - AmiId
      - Label:
          default: "Networking (Optional - use existing VPC)"
        Parameters:
          - ExistingVpcId
          - ExistingSubnetId

Conditions:
  CreateVpc: !Equals [!Ref ExistingVpcId, '']
  UseExistingVpc: !Not [!Equals [!Ref ExistingVpcId, '']]
  # Instance count conditions
  Launch1: !Not [!Equals [!Ref InstanceCount, 0]]
  Launch2: !Or [!Equals [!Ref InstanceCount, 2], !Equals [!Ref InstanceCount, 3], !Equals [!Ref InstanceCount, 4], !Equals [!Ref InstanceCount, 5], !Equals [!Ref InstanceCount, 6], !Equals [!Ref InstanceCount, 7], !Equals [!Ref InstanceCount, 8]]
  Launch3: !Or [!Equals [!Ref InstanceCount, 3], !Equals [!Ref InstanceCount, 4], !Equals [!Ref InstanceCount, 5], !Equals [!Ref InstanceCount, 6], !Equals [!Ref InstanceCount, 7], !Equals [!Ref InstanceCount, 8]]
  Launch4: !Or [!Equals [!Ref InstanceCount, 4], !Equals [!Ref InstanceCount, 5], !Equals [!Ref InstanceCount, 6], !Equals [!Ref InstanceCount, 7], !Equals [!Ref InstanceCount, 8]]
  Launch5: !Or [!Equals [!Ref InstanceCount, 5], !Equals [!Ref InstanceCount, 6], !Equals [!Ref InstanceCount, 7], !Equals [!Ref InstanceCount, 8]]
  Launch6: !Or [!Equals [!Ref InstanceCount, 6], !Equals [!Ref InstanceCount, 7], !Equals [!Ref InstanceCount, 8]]
  Launch7: !Or [!Equals [!Ref InstanceCount, 7], !Equals [!Ref InstanceCount, 8]]
  Launch8: !Equals [!Ref InstanceCount, 8]

Resources:
  # ============ NETWORKING (only created if no existing VPC) ============
  VPC:
    Type: AWS::EC2::VPC
    Condition: CreateVpc
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: CreateVpc
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: CreateVpc
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Condition: CreateVpc
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet'

  RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: CreateVpc
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: CreateVpc
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpc
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref RouteTable

  # ============ SECURITY GROUP ============
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RLVR cluster - SSH + internal traffic
      VpcId: !If [CreateVpc, !Ref VPC, !Ref ExistingVpcId]
      SecurityGroupIngress:
        # SSH from anywhere
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-sg'

  # Allow all traffic within the security group (for Ray, NCCL, EFA)
  SecurityGroupSelfIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SecurityGroup
      IpProtocol: -1
      SourceSecurityGroupId: !Ref SecurityGroup

  # ============ EFS ============
  EFSFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      PerformanceMode: generalPurpose
      ThroughputMode: elastic
      Encrypted: true
      FileSystemTags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-efs'

  EFSMountTarget:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !If [CreateVpc, !Ref PublicSubnet, !Ref ExistingSubnetId]
      SecurityGroups:
        - !Ref SecurityGroup

  # ============ PLACEMENT GROUP (for EFA) ============
  PlacementGroup:
    Type: AWS::EC2::PlacementGroup
    Properties:
      Strategy: cluster
      GroupName: !Sub '${AWS::StackName}-placement'

  # ============ IAM ROLE ============
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-role'

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole

  # ============ LAUNCH TEMPLATE ============
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplateName: !Sub '${AWS::StackName}-template'
      LaunchTemplateData:
        ImageId: !Ref AmiId
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Arn: !GetAtt InstanceProfile.Arn
        NetworkInterfaces:
          - DeviceIndex: 0
            SubnetId: !If [CreateVpc, !Ref PublicSubnet, !Ref ExistingSubnetId]
            Groups:
              - !Ref SecurityGroup
            AssociatePublicIpAddress: true
            InterfaceType: efa
        Placement:
          GroupName: !Ref PlacementGroup
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: 200
              VolumeType: gp3
              DeleteOnTermination: true
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${AWS::StackName}-node'
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -ex

            # Log everything
            exec > >(tee /var/log/user-data.log) 2>&1

            echo "=== Starting RLVR setup ==="

            # Wait for network
            sleep 10

            # Install dependencies
            apt-get update -y
            apt-get install -y nfs-common git build-essential

            # Create mount point and mount EFS
            mkdir -p /efs
            REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
            mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 \
              ${EFSFileSystem}.efs.${!REGION}.amazonaws.com:/ /efs

            # Make persistent
            echo "${EFSFileSystem}.efs.${!REGION}.amazonaws.com:/ /efs nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,_netdev 0 0" >> /etc/fstab

            # Fix ownership
            chown ubuntu:ubuntu /efs

            # Setup Ray tmpdir on NVMe
            mkdir -p /opt/dlami/nvme/ray_tmp
            chown ubuntu:ubuntu /opt/dlami/nvme/ray_tmp

            # Add to ubuntu's bashrc
            cat >> /home/ubuntu/.bashrc << 'EOF'

            # RLVR environment
            export RAY_TMPDIR=/opt/dlami/nvme/ray_tmp
            export PATH="$HOME/.local/bin:$PATH"
            export NUMEXPR_MAX_THREADS=64

            # Up/down arrow command history search
            bind '"\e[A": history-search-backward'
            bind '"\e[B": history-search-forward'
            EOF

            # Install uv as ubuntu user
            su - ubuntu -c 'curl -LsSf https://astral.sh/uv/install.sh | sh'

            # Clone repo and install deps (use flock to prevent race condition on shared EFS)
            (
              flock -n 200 || { echo "Another node is setting up, waiting..."; flock 200; }
              if [ ! -d /efs/rlvr-experiments/.git ]; then
                rm -rf /efs/rlvr-experiments  # clean up any partial clone
                su - ubuntu -c 'git clone https://github.com/halflearned/rlvr-experiments.git /efs/rlvr-experiments'
              fi
              if [ ! -d /efs/rlvr-experiments/.venv ]; then
                su - ubuntu -c 'cd /efs/rlvr-experiments && $HOME/.local/bin/uv sync'
              fi
            ) 200>/efs/.clone.lock

            echo "=== RLVR setup complete ==="

  # ============ INSTANCES ============
  # Direct EC2 instances (no auto-recovery - if they die, they die)
  Instance1:
    Type: AWS::EC2::Instance
    Condition: Launch1
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-1'

  Instance2:
    Type: AWS::EC2::Instance
    Condition: Launch2
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-2'

  Instance3:
    Type: AWS::EC2::Instance
    Condition: Launch3
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-3'

  Instance4:
    Type: AWS::EC2::Instance
    Condition: Launch4
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-4'

  Instance5:
    Type: AWS::EC2::Instance
    Condition: Launch5
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-5'

  Instance6:
    Type: AWS::EC2::Instance
    Condition: Launch6
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-6'

  Instance7:
    Type: AWS::EC2::Instance
    Condition: Launch7
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-7'

  Instance8:
    Type: AWS::EC2::Instance
    Condition: Launch8
    DependsOn: EFSMountTarget
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-node-8'

Outputs:
  VPCID:
    Description: VPC ID
    Value: !If [CreateVpc, !Ref VPC, !Ref ExistingVpcId]

  SubnetID:
    Description: Subnet ID
    Value: !If [CreateVpc, !Ref PublicSubnet, !Ref ExistingSubnetId]

  SecurityGroupID:
    Description: Security Group ID
    Value: !Ref SecurityGroup

  EFSFileSystemID:
    Description: EFS File System ID
    Value: !Ref EFSFileSystem

  SSHCommand:
    Description: SSH command (get instance IPs from EC2 console)
    Value: !Sub 'ssh -i ~/.ssh/${KeyName}.pem ubuntu@<INSTANCE_PUBLIC_IP>'

  NextSteps:
    Description: After instances are running
    Value: |
      1. Get instance IPs from EC2 console
      2. SSH to any instance: ssh -i <key>.pem ubuntu@<ip>
      3. Check setup logs: cat /var/log/user-data.log
      4. Activate env: cd /efs/rlvr-experiments && source .venv/bin/activate
      5. Run training: python entrypoints/train_grpo.py configs/qwen3-06B-base.yaml
